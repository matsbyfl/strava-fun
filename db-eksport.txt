select version, fom_date, tom_date, deployer, env_name, app_name from version, t_environment, t_application where (env_type = env_id and app_type = app_id) into outfile '/tmp/vera-eksport.csv' fields terminated by ',' enclosed by '"' escaped by '';
vim /tmp/vera-eksport.csv -> set fileencoding=utf-8 -> :wq

legg til headerlinje (version,deployed_timestamp,replaced_timestamp,deployer,environment,application)

mongoimport --db deploy_log --collection events --type csv --file /home/H129009/vera-eksport.csv --headerline

mongo deploy_log mongodb-migration.js


...........

db.events.find({replaced_timestamp: "NULL"}).forEach(function(e){e.replaced_timestamp = ""; db.events.save(e);})
db.events.find({deployer: "NULL"}).forEach(function(e){e.deployer = "n/a"; db.events.save(e);})

// la alle timestamps være på isodate formatet
db.events.find().forEach(function(a){a.deployed_timestamp = ISODate(a.deployed_timestamp); db.events.save(a)});
db.events.find().forEach(function(a){a.replaced_timestamp = ISODate(a.replaced_timestamp); db.events.save(a)});

//lowercase env og app
db.events.find().forEach(function(e){e.application = e.application.toLowerCase(); e.environment = e.environment.toLowerCase(); db.events.save(e);})

// remove shitty environments
db.events.find({$or: [{environment: 'k3'}, {environment: 'k7'}, {environment: 'o1'}, {environment: 'o2'}]} ).forEach(function(e){db.events.remove(e)})

//REMOVE all entries where we have a useless version
db.events.find({$or:[{version: '-' },{version: 'n.p'},{version: 'No MF-vn.'}]}).forEach(function(e){db.events.remove(e)} )



----------------------------------
//trengs ikke lenger?

// sett alle events med latest 0 til false og 1 til true
db.events.find({latest: 0}).forEach(function(a){a.latest = false; db.events.save(a);})
db.events.find({latest: 1}).forEach(function(a){a.latest = true; db.events.save(a);})

// fjern events der application er tom
db.events.find({ application: { $exists: false}}).forEach(function(e){db.events.remove(e);})

//fjern events der environment er tom
db.events.find({ environment: ""}).forEach(function(e){db.events.remove(e);})


#sed s/NULL/\"\"/g < /tmp/eksport.csv > /tmp/vera_eksport_fixed.csv

(fixdata.sh)
#!/bin/bash

awk '
    BEGIN {
        FS=OFS=","
    }
    {
        if ($3 != "\"\""){
            $3="0"
        } else {
            $3="1"
        }

        print $0
    }
' eksport-vera-fixed.csv > output_without_fnuttz.csv
